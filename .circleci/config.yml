version: 2

references:
  environment: &environment
    environment:
      MINICONDA: ~/miniconda
      JUNIT_REPORT_PATH: /tmp/reports/ # trailing slash required
      ARTIFACT_PATH: /tmp/artifacts/
      MAKEFLAGS: -j8

  configure: &configure
    name: Running Configure
    command: |
      eval MINICONDA=$MINICONDA
      cd ~/build
      ~/project/configure \
      --disable-docs \
      --prefix=$HOME/install \
      --with-boost=$MINICONDA  \
      --with-boost-libdir=$MINICONDA/lib \
      --with-arbhome=$MINICONDA/lib/arb \
      $EXTRA_CONFIG_ARGS \
      LDFLAGS="$LDFLAGS -Wl,-rpath -Wl,$MINICONDA/lib" \
      || (cat config.log; false)

  macos: &macos
    macos:
      xcode: "9.0"
  linux: &linux
    docker:
      - image: condaforge/linux-anvil
        environment:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8

jobs:
  build:
    <<: *environment
    <<: *linux
    docker:
      - image: condaforge/linux-anvil
        environment:
    steps:
      - checkout
      - restore_cache:
          keys:
            - conda-{{arch}}
      - run:
          name: Preparing Conda Environment
          command: ./ci_scripts/install_conda.sh
      - save_cache:
          key: conda-{{arch}}-{{checksum "conda/info.txt" }}-{{checksum "conda/root.txt"}}-{{checksum "conda/pkgs.txt"}}
          paths: ~/miniconda
      - run:
          name: Checking out submodules
          command: git submodule update --init --recursive --remote
      - run:
          name: Preparing Directory Structure
          command: mkdir ~/build $JUNIT_REPORT_PATH $ARTIFACT_PATH
      - run:
          name: Boostrapping Configure
          command: ./autogen.sh
      - run:
          name: Installing lcov
          command: |
            /usr/bin/sudo -n yum install -y epel-release
            /usr/bin/sudo -n yum install -y lcov
      - run:
          <<: *configure
          environment:
            EXTRA_CONFIG_ARGS: --enable-code-coverage
      - run:
          name: Building
          command: make -C ~/build all
      - run:
          name: Running Unit Tests
          command: make -C ~/build check-code-coverage
      - run:
          name: Copying logs
          when: always
          command: |
            ls -la $JUNIT_REPORT_PATH
            mkdir -p $ARTIFACT_PATH/tests
            find ~/build -name \*.log -exec cp {} $ARTIFACT_PATH/tests \;
      - run:
          name: Updating coverage
          command: |
            bash <(curl -s https://codecov.io/bash) -s ~/build
      - store_test_results:
          path: /tmp/reports
      - store_artifacts:
          path: /tmp/artifacts

